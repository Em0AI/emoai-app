# 系统架构设计

## 架构概述

EmoAI 是一个基于 AI 的心理治愈 Web 应用。采用现代的前后端分离架构，前端使用 Nuxt.js 框架实现，后端可选用 Node.js 或 Python 等技术栈。

### 核心功能
1. **首页选角色**：用户选择 AI 陪伴者（三个角色）
2. **AI 聊天**：与选定角色进行治愈式对话
3. **情绪追踪**：自动生成情绪日记和可视化报告
4. **安全保护**：危机干预机制

---

## 整体架构设计

### 分层架构

```
┌─────────────────────────────────────────────────┐
│         用户界面层 (Presentation Layer)           │
│  ┌──────────────┬──────────────┬──────────────┐  │
│  │   首页       │   聊天页     │   日记页     │  │
│  │ (Characters) │  (Chat)      │  (Diary)     │  │
│  └──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────────┐
│      业务逻辑层 (Business Logic Layer)            │
│  ┌──────────────┬──────────────┬──────────────┐  │
│  │  聊天逻辑    │  日记生成    │ 情绪分析     │  │
│  │  (useChat)   │ (useDiary)   │(useEmotion)  │  │
│  └──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────────┐
│        状态管理层 (State Management Layer)        │
│  ┌──────────────┬──────────────┬──────────────┐  │
│  │  ChatStore   │  DiaryStore  │  UserStore   │  │
│  │  (Pinia)     │              │              │  │
│  └──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────────┐
│        API 服务层 (API Service Layer)            │
│  ┌──────────────┬──────────────┬──────────────┐  │
│  │   AI 服务    │ 情绪检测     │ 日记生成     │  │
│  │ (aiService)  │(emotionSvc)  │(diarySvc)    │  │
│  └──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────────────┐
│      外部服务层 (External Services)              │
│  ┌──────────────┬──────────────┬──────────────┐  │
│  │   LLM API    │ 情绪分析模型 │ 数据存储     │  │
│  │ (OpenAI等)   │   (本地)     │(LocalStor.)  │  │
│  └──────────────┴──────────────┴──────────────┘  │
└─────────────────────────────────────────────────┘
```

---

## 数据流架构

### 聊天交互流程

```
用户输入文字/语音
      ↓
转换为文本
      ↓
发送消息到 AI
      ↓ (流式接收)
实时显示 AI 回复
      ↓
情绪分析和安全检测
      ↓
存储聊天记录
      ↓
更新 ChatStore
      ↓
实时更新情绪数据
```

### 日记生成流程

```
用户进入日记页面
      ↓
加载该日期聊天记录
      ↓
提取文本内容
      ↓
进行 6 维度情绪分析
      ↓
生成关键词（规则选取）
      ↓
调用 AI 生成报告内容
├─ 情绪变化趋势
├─ 心情小结
├─ 小小觉察
├─ 温柔小练习
└─ 今日寄语
      ↓
生成雷达图数据
      ↓
显示完整日记
```

---

## 技术架构决策

### 前端框架选择：Nuxt.js 3

**为什么选择 Nuxt.js？**
- 完整的 Vue 3 集成和 TypeScript 支持
- 内置路由系统和自动化代码分割
- SSR/SSG 支持，更好的 SEO
- 丰富的生态和官方维护

**相比 Vue + Router 的优势**
- 零配置的项目结构
- 自动化的页面路由
- 更好的性能优化
- 官方插件生态完整

### 状态管理：Pinia

**为什么选择 Pinia？**
- 比 Vuex 更简洁易用
- 完整的 TypeScript 支持
- 自动代码分割
- Vue 官方推荐

**Store 设计**
- ChatStore：聊天消息、当前对话
- DiaryStore：日记数据、历史记录
- UserStore：用户选择、偏好设置
- AppStore：全局 UI 状态

### AI 集成：ai-sdk

**为什么选择 ai-sdk？**
- 统一的 LLM 接口（OpenAI、Claude、Gemini 等）
- 原生支持流式响应
- Vercel 官方维护
- 类型安全和易用

**流式响应处理**
- 使用 EventSource 处理 SSE 流
- 实时显示 AI 回复
- 更好的用户体验

### 样式系统：TailwindCSS + @nuxt/ui

**选择理由**
- 快速开发，已有组件库
- 响应式设计完整
- 与 Nuxt 深度集成
- 可配置的主题

---

## 项目结构

### 完整目录树

```
frontend/
├── src/
│   ├── components/
│   │   ├── home/
│   │   │   ├── CharacterCard.vue         # 角色卡片
│   │   │   └── CharacterGrid.vue         # 角色网格
│   │   ├── chat/
│   │   │   ├── ChatWindow.vue            # 聊天窗口
│   │   │   ├── ChatMessage.vue           # 消息气泡
│   │   │   ├── InputArea.vue             # 输入区域
│   │   │   ├── VoiceRecorder.vue         # 语音录制
│   │   │   ├── CharacterAvatar.vue       # 角色头像
│   │   │   └── CrisisAlert.vue           # 危机提示
│   │   ├── diary/
│   │   │   ├── DiaryList.vue             # 日记列表
│   │   │   ├── DiaryContent.vue          # 日记内容
│   │   │   ├── MoodRadar.vue             # 雷达图
│   │   │   └── MoodStats.vue             # 情绪统计
│   │   └── common/
│   │       ├── Navigation.vue            # 导航栏
│   │       ├── Modal.vue                 # 弹窗框架
│   │       └── LoadingSpinner.vue        # 加载动画
│   │
│   ├── pages/
│   │   ├── index.vue                     # 首页
│   │   ├── chat/
│   │   │   └── [role].vue                # 聊天页面
│   │   └── diary.vue                     # 日记页面
│   │
│   ├── stores/
│   │   ├── chat.ts                       # 聊天状态
│   │   ├── diary.ts                      # 日记状态
│   │   ├── user.ts                       # 用户状态
│   │   └── app.ts                        # 应用状态
│   │
│   ├── composables/
│   │   ├── useChat.ts                    # 聊天逻辑
│   │   ├── useAI.ts                      # AI 服务调用
│   │   ├── useEmotion.ts                 # 情绪分析
│   │   ├── useDiary.ts                   # 日记生成
│   │   └── useVoice.ts                   # 语音输入
│   │
│   ├── services/
│   │   ├── aiService.ts                  # AI 调用服务
│   │   ├── emotionService.ts             # 情绪分析服务
│   │   └── diaryService.ts               # 日记生成服务
│   │
│   ├── types/
│   │   ├── chat.ts                       # 聊天类型
│   │   ├── diary.ts                      # 日记类型
│   │   ├── emotion.ts                    # 情绪类型
│   │   ├── character.ts                  # 角色类型
│   │   └── index.ts                      # 导出
│   │
│   ├── utils/
│   │   ├── constants.ts                  # 常量定义
│   │   ├── validators.ts                 # 数据验证
│   │   ├── formatters.ts                 # 格式化函数
│   │   ├── helpers.ts                    # 辅助函数
│   │   └── emotionKeywords.ts            # 情绪关键词
│   │
│   ├── assets/
│   │   ├── images/
│   │   │   └── characters/               # 角色头像
│   │   └── styles/
│   │       └── global.css                # 全局样式
│   │
│   └── app.vue                           # 根组件
│
├── nuxt.config.ts                        # Nuxt 配置
├── tsconfig.json                         # TypeScript 配置
├── package.json                          # 项目依赖
└── README.md                             # 项目说明
```

---

## 关键模块详解

### 1. 首页模块 (Home Module)
- **职责**：展示三个 AI 角色，用户选择后进入聊天
- **关键组件**：CharacterCard, CharacterGrid
- **路由**：`/` (index.vue)
- **核心功能**：角色展示、选择交互、跳转聊天

### 2. 聊天模块 (Chat Module)
- **职责**：实现用户与 AI 的实时聊天交互
- **关键组件**：ChatWindow, ChatMessage, InputArea, VoiceRecorder
- **路由**：`/chat/[role]` 
- **核心功能**：消息管理、AI 调用、情绪分析、危机检测
- **状态管理**：ChatStore

### 3. 日记模块 (Diary Module)
- **职责**：生成和展示情绪日记
- **关键组件**：DiaryList, DiaryContent, MoodRadar
- **路由**：`/diary`
- **核心功能**：日期切换、日记展示、雷达图、统计信息
- **状态管理**：DiaryStore

### 4. 公共组件 (Common Components)
- **Navigation**：顶部导航栏
- **Modal**：通用弹窗框架
- **CrisisAlert**：危机干预提示
- **LoadingSpinner**：加载动画

---

## 技术决策记录

| 决策 | 选择 | 理由 |
|------|------|------|
| 前端框架 | Nuxt.js 3 | 完整的 Vue 3 集成，内置路由和优化 |
| 状态管理 | Pinia | 简洁易用，完整 TS 支持 |
| UI 框架 | @nuxt/ui | 组件丰富，与 Nuxt 深度集成 |
| 样式 | TailwindCSS | 快速开发，响应式完整 |
| AI 集成 | ai-sdk | 统一接口，支持多个 LLM 提供商 |
| 流式处理 | SSE + EventSource | 实时感知，更好的 UX |
| 数据存储 | 后端 API + 前端内存 + 前端角色常量 | 用户数据安全，角色无需 API 调用，聊天即时响应 |
| 部署 | Vercel | 完全无服务，自动化部署 |

---

## 性能考虑

### 前端性能
- **代码分割**：按路由和组件自动分割
- **组件懒加载**：大型组件动态导入
- **图片优化**：使用 WebP 和 CDN
- **角色常量**：直接引入，无需网络请求

### 通信性能
```

---

## 性能考虑

### 前端性能
- **代码分割**：按路由和组件自动分割
- **组件懒加载**：大型组件动态导入
- **图片优化**：使用 WebP 和 CDN
- **缓存策略**：聊天记录和日记本地缓存

### 通信性能
- **流式响应**：减少首字节延迟
- **消息压缩**：减少传输大小
- **请求去抖**：避免重复请求

### 状态管理性能
- **选择性订阅**：只订阅需要的数据
- **计算属性缓存**：避免重复计算
- **虚拟滚动**：长列表优化

---

## 安全性设计

### 数据安全
- 用户数据完全由后端管理和存储
- 前端仅显示数据，不修改或删除
- 聊天记录仅在当前会话内存中，刷新即清空
- 敏感信息（API 密钥等）通过环境变量管理

### API 安全
- 使用 HTTPS 加密传输
- API 密钥环境变量管理
- 输入验证和清理
- 错误消息不泄露敏感信息

### 用户安全
- 危机干预机制
- 极端情绪检测
- 应急求助电话提示

---

## 下一步

本文档提供了系统的整体架构设计。具体实现细节请参考：

- 📄 [模块设计](./module-design.md) - 各功能模块的详细设计
- 📄 [数据模型](./data-models.md) - 数据结构和类型定义
- 📄 [开发指南](./development-guide.md) - 本地开发和编码规范
